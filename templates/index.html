
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YouTube Downloader</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #1b1b1b; color: #f1f1f1; font-family: Arial, sans-serif; padding:20px;}
.container{ max-width:600px;margin:auto;}
.btn-custom{ background:#ff4500;border:none;}
.btn-custom:hover{ background:#ff6347;}
select,input{margin-bottom:15px;}
.progress{height:30px; background:#333; border-radius:5px; overflow:hidden;}
#progress-bar { transition: width 0.3s ease, background-color 0.3s ease; width:0%; color:#fff; font-weight:bold; text-align:center; line-height:30px;}
#info {margin-top:10px; font-size:0.9rem;}
#thumbnail {width:100%; max-height:200px; margin-bottom:15px; display:none; border-radius:5px;}
@media(max-width:576px){ .container{padding:10px;} }
</style>
</head>
<body>
<div class="container">
<h2 class="mb-4 text-center">YouTube Downloader</h2>

<img id="thumbnail" src="">
<div id="title" style="margin-bottom:10px;font-weight:bold;"></div>

<input type="text" id="url" class="form-control" placeholder="Enter YouTube URL">
<select id="format" class="form-select">
<option value="mp4">MP4</option>
<option value="mp3">MP3</option>
</select>
<select id="quality" class="form-select">
<option value="1080">1080p</option>
<option value="720">720p</option>
<option value="480">480p</option>
<option value="360">360p</option>
<option value="best">Best</option>
</select>

<div class="d-flex gap-2 mt-2">
<button class="btn btn-custom flex-fill" onclick="startDownload()">Download</button>
<button class="btn btn-danger flex-fill" id="cancelBtn" onclick="cancelDownload()" style="display:none;">Cancel</button>
</div>

<div class="mt-4">
<div class="progress">
<div id="progress-bar" class="progress-bar" role="progressbar">0%</div>
</div>
<div id="info"></div>
</div>
</div>

<script>
const formatSelect=document.getElementById('format');
const qualitySelect=document.getElementById('quality');
const progressBar=document.getElementById('progress-bar');
const infoDiv=document.getElementById('info');
const titleDiv=document.getElementById('title');
const thumbnail=document.getElementById('thumbnail');
const cancelBtn=document.getElementById('cancelBtn');

let currentID = null;

formatSelect.addEventListener('change',()=>{
  qualitySelect.style.display = formatSelect.value==='mp3'?'none':'block';
});

function formatBytes(bytes){
  if(bytes===0) return '0 B';
  const k=1024, sizes=['B','KB','MB','GB','TB'];
  const i=Math.floor(Math.log(bytes)/Math.log(k));
  return (bytes/k**i).toFixed(2)+' '+sizes[i];
}

function formatSpeed(speed){return formatBytes(speed)+'/s';}

function formatETA(eta){
  const m=Math.floor(eta/60);
  const s=eta%60;
  return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function getColor(percent){
    let r,g,b=0;
    if(percent<=50){ r=255; g=Math.floor(165*(percent/50)); }
    else{ r=Math.floor(255-(255*(percent-50)/50)); g=165+Math.floor(90*((percent-50)/50)); }
    return `rgb(${r},${g},${b})`;
}

async function startDownload(){
  const url=document.getElementById('url').value;
  const format=formatSelect.value;
  const quality=qualitySelect.value;

  const response=await fetch("http://127.0.0.1:5000/download",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({url,format,quality})
  });
  if(!response.ok){alert("Download failed!"); return;}
  const data=await response.json();
  currentID = data.id;

  titleDiv.innerText = data.title;
  if(data.thumbnail){ thumbnail.src = data.thumbnail; thumbnail.style.display='block'; }

  cancelBtn.style.display = 'inline-block';

  const evtSource=new EventSource(`http://127.0.0.1:5000/progress/${currentID}`);
  evtSource.onmessage=(e)=>{
    let [percent,speed,eta,downloaded,total]=e.data.split('|').map(Number);
    progressBar.style.width=percent+'%';
    progressBar.innerText=percent+'%';
    progressBar.style.backgroundColor = getColor(percent);
    infoDiv.innerText = `${formatBytes(downloaded)} / ${formatBytes(total)} | ${formatSpeed(speed)} | ETA: ${formatETA(eta)}`;
    if(percent>=100){
        evtSource.close();
        cancelBtn.style.display='none';
        notifyUser(data.title);
    }
  }

  const pollFile=async()=>{
    let fileReady=false;
    while(!fileReady){
      try{
        const fileResponse=await fetch(`http://127.0.0.1:5000/file/${currentID}`);
        if(fileResponse.ok){
          const blob=await fileResponse.blob();
          const a=document.createElement("a");
          a.href=window.URL.createObjectURL(blob);
          a.download=format==='mp3'?'audio.mp3':'video.mp4';
          a.click();
          fileReady=true;
          progressBar.style.width='0%'; progressBar.innerText='0%';
          infoDiv.innerText='';
          titleDiv.innerText='';
          thumbnail.style.display='none';
        }
      }catch(err){await new Promise(r=>setTimeout(r,500));}
    }
  };
  pollFile();
}

// Cancel download
async function cancelDownload(){
  if(!currentID) return;
  await fetch(`http://127.0.0.1:5000/cancel/${currentID}`,{method:'POST'});
  progressBar.style.width='0%'; progressBar.innerText='0%';
  infoDiv.innerText='Download cancelled';
  titleDiv.innerText=''; thumbnail.style.display='none';
  cancelBtn.style.display='none';
}

// Browser notification
function notifyUser(title){
    if(Notification.permission==='granted'){
        new Notification('Download Complete', {body:title});
    } else if(Notification.permission!=='denied'){
        Notification.requestPermission().then(p=>{
            if(p==='granted') new Notification('Download Complete', {body:title});
        });
    }
}
</script>
</body>
</html>

